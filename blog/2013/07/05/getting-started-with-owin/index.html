<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Vu Hai Do" />
    <title>Getting started with OWIN</title>        
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/styles.css">  
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css">   
    <link href="http://feeds.feedburner.com/github/dohaivu" rel="alternate" title="RSS" type="application/rss+xml" />
  </head>

  <body>
    <header id="header" class="section">
      <!-- <div class="wrapper">
        <strong id="blog-title">
          <a href="/" rel="home">A Passion Developer</a>
        </strong>
        <p id="blog-description"></p>
      </div> -->
    </header>
    <nav class="navigation">
      <ul class="">
        <li class="navigation_menu-item"><a href="/index.html">Home</a></li>            
        <li class="navigation_menu-item"><a href="/blog.html">Blog</a></li>            
        <li class="navigation_menu-item"><a href="/about.html">About</a></li>
      </ul>
    </nav>
    <br class="clearboth"/> 
    <div class="main">
      <div id="content-post" class="entry">
	<div class="full">
	  <h1 class="entry-title">
		<a href="/blog/2013/07/05/getting-started-with-owin/" title="Getting started with OWIN" rel="bookmark">Getting started with OWIN</a>
	  </h1>
	  <div class="entry-content">
		<p>Owin is an Open Web Interface for .NET, it describes how components in a HTTP pipeline should communicate, like NodeJS Connect or Rack.</p>

<!--break-->

<p>Owin has one main interface, every components will communicate through this interface. </p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="n">Func</span><span class="p">&lt;</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span><span class="n">Task</span><span class="p">&gt;</span>

<span class="c1">//Actual implementation</span>
<span class="k">public</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">environment</span><span class="p">)</span> 
<span class="p">{</span> 
   <span class="kt">var</span> <span class="n">someObject</span> <span class="p">=</span> <span class="n">environment</span><span class="p">[</span><span class="err">“</span><span class="n">some</span><span class="p">.</span><span class="n">key</span><span class="err">”</span><span class="p">]</span> <span class="k">as</span> <span class="n">SomeObject</span><span class="p">;</span> 
   <span class="c1">// etc… </span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://owin.org/spec/owin-1.0.0.html">Owin specs</a> contains details of IDictionary object.</p>

<p>Owin host will composes multiple middlewares into a application. It will implement the following interface</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IAppBuilder</span> 
<span class="p">{</span> 
    <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">Properties</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">object</span> <span class="nf">Build</span><span class="p">(</span><span class="n">Type</span> <span class="n">returnType</span><span class="p">);</span> 
    <span class="n">IAppBuilder</span> <span class="nf">New</span><span class="p">();</span> 
    <span class="n">IAppBuilder</span> <span class="nf">Use</span><span class="p">(</span><span class="kt">object</span> <span class="n">middleware</span><span class="p">,</span> <span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">args</span><span class="p">);</span> 
<span class="p">}</span>
</code></pre></div>
<p>We compose middlewares in <strong>Configuration</strong> method of <strong>Startup</strong> class. When OwinHost starts, it looks into Configuration method to build up middlewares of our app.</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">builder</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Logger</span><span class="p">));</span>      
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Let build a simple logger and a request handler middleware</p>

<ul>
<li>Create new blank MVC4 (or MVC5) project <strong>OwinTest</strong></li>
<li><p>Add the following packages:</p>

<p><strong>Install-Package Owin</strong><br>
<strong>Install-Package Install-Package Microsoft.Owin.Host.HttpListener -Pre</strong></p></li>
<li><p>Create a new class <strong>Logger</strong> and enter the following code</p></li>
</ul>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">AppFunc</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&gt;;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Logger</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">AppFunc</span> <span class="n">_next</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">Logger</span><span class="p">(</span><span class="n">AppFunc</span> <span class="n">next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">next</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">environment</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0} {1}&quot;</span><span class="p">,</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span> <span class="n">environment</span><span class="p">[</span><span class="s">&quot;owin.RequestPath&quot;</span><span class="p">]));</span>
        <span class="k">return</span> <span class="nf">_next</span><span class="p">(</span><span class="n">environment</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Create a class <strong>Startup</strong> and enter the following code</li>
</ul>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">builder</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Logger</span><span class="p">));</span>      
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Download <a href="http://katanaproject.codeplex.com/releases/view/102220">Katana hosting</a>, extract to <strong>C:\</strong> (or any folder)</li>
<li>Open Project property, confiure <strong>Start external program</strong><br>
<img src="/images/posts/2013-07-05-getting-started-with-owin_projectproperty.png" alt="Project property"></li>
<li><p>Press <strong>F5</strong> and browse <strong>http://localhost:8080</strong> the console will show like this
<img src="/images/posts/2013-07-05-getting-started-with-owin_consoleresult.png" alt="console result"></p></li>
<li><p>Add a class <strong>HelloRequestHandler</strong> and enter the following code</p></li>
</ul>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">AppFunc</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&gt;;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HelloRequestHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">AppFunc</span> <span class="n">_next</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">HelloRequestHandler</span><span class="p">(</span><span class="n">AppFunc</span> <span class="n">next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">next</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">environment</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]&gt;</span> <span class="n">responseHeaders</span> <span class="p">=</span>
                <span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]&gt;)</span><span class="n">environment</span><span class="p">[</span><span class="s">&quot;owin.ResponseHeaders&quot;</span><span class="p">];</span>
        <span class="kt">var</span> <span class="n">responseBytes</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">ASCIIEncoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span>
                     <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;&lt;h1&gt;Hello world&lt;/h1&gt;&quot;</span><span class="p">));</span>
        <span class="n">Stream</span> <span class="n">responseStream</span> <span class="p">=</span> <span class="p">(</span><span class="n">Stream</span><span class="p">)</span><span class="n">environment</span><span class="p">[</span><span class="s">&quot;owin.ResponseBody&quot;</span><span class="p">];</span>

        <span class="n">responseHeaders</span><span class="p">[</span><span class="s">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">responseBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">)</span> <span class="p">};</span>
        <span class="n">responseHeaders</span><span class="p">[</span><span class="s">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;text/html&quot;</span> <span class="p">};</span>
        <span class="n">responseStream</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">responseBytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">responseBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">_next</span><span class="p">(</span><span class="n">environment</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add <strong>HelloRequestHandler</strong> middleware to Startup class</li>
</ul>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">builder</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Logger</span><span class="p">));</span>
      <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">HelloRequestHandler</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Press <strong>F5</strong> and browse <strong>http://localhost:8080</strong> we will see the result like this
<img src="/images/posts/2013-07-05-getting-started-with-owin_hellorequesthandler.png" alt="browser result"></li>
</ul>

<p>ASP.NET MVC5, WEB API 2, SignalR are compatible with OWIN, so we can compose middlewares or develop middlewares for our application&#39;s need.</p>

		<div class="clear"></div>
	  </div>
	  <p class="alt-font tight">
		Posted in&nbsp;
		
		<a href="/categories/dotnet" title="dotnet" rel="category tag">dotnet</a>
		
		&nbsp;&nbsp;&nbsp;
		Tags &nbsp;
		
			<a href="/tags/owin/">owin</a> &nbsp;
		
			<a href="/tags/component/">component</a> &nbsp;
		
	  </p>
		
	  <p class="by-line">
		<span class="date full-date">
		  <abbr class="published" title="2013-07-05 00:00:00 +0700">05 Jul 2013</abbr>
		</span>
	  </p>
	  <div class="clear"></div>
	</div>
</div>		     
    </div>
    <br class="clearboth"/>
    <footer>
      Powered by <a href="https://jekyllrb.com" rel="generator">Jekyll</a> and hosted on <a href="https://github.com/dohaivu/dohaivu.github.io">Github Pages</a>
    </footer>    
    <!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>-->
  </body>
</html>