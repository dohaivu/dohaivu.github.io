<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Vu Hai Do" />
    <title>Logging Application Block</title>        
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/styles.css">  
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css">   
    <link href="http://feeds.feedburner.com/github/dohaivu" rel="alternate" title="RSS" type="application/rss+xml" />
  </head>

  <body>
    <header id="header" class="section">
      <!-- <div class="wrapper">
        <strong id="blog-title">
          <a href="/" rel="home">A Passion Developer</a>
        </strong>
        <p id="blog-description"></p>
      </div> -->
    </header>
    <nav class="navigation">
      <ul class="">
        <li class="navigation_menu-item"><a href="/index.html">Home</a></li>            
        <li class="navigation_menu-item"><a href="/blog.html">Blog</a></li>            
        <li class="navigation_menu-item"><a href="/about.html">About</a></li>
      </ul>
    </nav>
    <br class="clearboth"/> 
    <div id="content-post" class="entry">
	<div class="full">
	  <h1 class="entry-title">
		<a href="/blog/2013/05/18/logging-application-block/" title="Logging Application Block" rel="bookmark">Logging Application Block</a>
	  </h1>
	  <div class="entry-content">
		<p>The Logging block in Enterprise Library 6 is enhanced with some nice features:
- Support asynchronous
- JSON formatter
- Priority filter
- LoggingEnabled</p>

<!--break-->

<h3 id="toc_0">Purpose of logging</h3>

<ul>
<li>Monitoring application performance: errors, failure</li>
<li>Providing information: audit user behavior, what tasks are processed, what information are read</li>
</ul>

<p>The logging application block is highly flexible and configurable solution that allow you to create and store log messages in a wide variety of location, categorize and filter messages</p>

<h3 id="toc_1">Configuring the Logging block</h3>

<p>We can configure logging block by using programmatic configuration or configuring in web.config</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="c1">// Formatter</span>
<span class="n">TextFormatter</span> <span class="n">briefFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextFormatter</span><span class="p">(...);</span>
<span class="c1">// Trace Listener</span>
<span class="kt">var</span> <span class="n">flatFileTraceListener</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FlatFileTraceListener</span><span class="p">(</span>
<span class="s">@&quot;C:\Temp\FlatFile.log&quot;</span><span class="p">,</span> <span class="s">&quot;----------------------------------------&quot;</span><span class="p">,</span> <span class="s">&quot;----------------------------------------&quot;</span><span class="p">,</span> <span class="n">briefFormatter</span><span class="p">);</span>
<span class="c1">// Build Configuration</span>
<span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LoggingConfiguration</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">AddLogSource</span><span class="p">(</span><span class="s">&quot;DiskFiles&quot;</span><span class="p">,</span> <span class="n">SourceLevels</span><span class="p">.</span><span class="n">All</span><span class="p">,</span> <span class="k">true</span><span class="p">).</span><span class="n">AddTraceListener</span><span class="p">(</span><span class="n">flatFileTraceListener</span><span class="p">);</span>
<span class="n">LogWriter</span> <span class="n">defaultWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogWriter</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</code></pre></div>
<h3 id="toc_2">Logging Asynchronously</h3>

<p>In this new version, Logging block support asynchronous trace lister. You should you this when you have high volume of trace messages, or performance is critical you.</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">databaseTraceListener</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FormattedDatabaseTraceListener</span><span class="p">(</span>
<span class="n">DatabaseFactory</span><span class="p">.</span><span class="n">CreateDatabase</span><span class="p">(</span><span class="s">&quot;ExampleDatabase&quot;</span><span class="p">),</span><span class="s">&quot;WriteLog&quot;</span><span class="p">,</span> <span class="s">&quot;AddCategory&quot;</span><span class="p">,</span><span class="n">extendedFormatter</span><span class="p">);</span>
<span class="n">config</span><span class="p">.</span><span class="n">AddLogSource</span><span class="p">(</span><span class="s">&quot;AsyncDatabase&quot;</span><span class="p">,</span> <span class="n">SourceLevels</span><span class="p">.</span><span class="n">All</span><span class="p">,</span> <span class="k">true</span><span class="p">).</span><span class="n">AddAsynchronousTraceListener</span><span class="p">(</span><span class="n">databaseTraceListener</span><span class="p">);</span>
</code></pre></div><div class="highlight"><pre><code class="xml language-xml" data-lang="xml"><span class="nt">&lt;listeners&gt;</span>
 <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Rolling Flat File Trace Listener&quot;</span> <span class="na">type=</span><span class="s">&quot;...&quot;</span> <span class="na">listenerDataType=</span><span class="s">&quot;...&quot;</span> <span class="na">formatter=</span><span class="s">&quot;Text Formatter&quot;</span> <span class="na">rollInterval=</span><span class="s">&quot;Day&quot;</span> <span class="na">asynchronous=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/listeners&gt;</span>
</code></pre></div>
<h3 id="toc_3">Log category</h3>

<p>Categories are the way that Enterprise Library routes events sent to the block to the appropriate target, such as a database, the event log, an e-mail message, and more.</p>

<h3 id="toc_4">Filter</h3>

<h4 id="toc_5">Filter by category</h4>

<p>Use <strong>CategoryFilter</strong> class to send log entries to a category. You can add multiple categories to your configuration to manage filtering.</p>

<h4 id="toc_6">Filter by priority</h4>

<p>This filter has two properties: <strong>Minimum Priority</strong> and <strong>Maximum Priority</strong>. Only entry that has priority between two values will be logged. Default value is <strong>-1</strong>, mean does not block any log entry.</p>

<h4 id="toc_7">Filtering by Severity in a Trace Listener</h4>

<p>We can filter log entries by severity in listener: Error, Information, Debug, Critical</p>

<h3 id="toc_8">Formatters</h3>

<p>The Logging log provide some formatter: XmlLogFormatter, JsonFormatter, FlatFileFormatter</p>

<h3 id="toc_9">Capturing Unprocessed Events and Logging Errors</h3>

<p>Capture log that don&#39;t match any categories. Configure listener for the following categories</p>

<ul>
<li>All Events: receives all events</li>
<li>Unprocessed Category: receives any log entry that has a category that does not match any configured categories.</li>
<li>Logging Errors &amp; Warnings:  receives any log entry that causes an error in the logging process</li>
</ul>

<h3 id="toc_10">Testing Logging Filter Status</h3>

<p><strong>ShowDetailsAndAddExtraInfo</strong> shows whether it is block by specific filters and shows how you can obtain information about the way that the Logging block will handle the log entry.</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">entry1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LogEntry</span><span class="p">(...);</span>
<span class="n">ShowDetailsAndAddExtraInfo</span><span class="p">(</span><span class="n">entry1</span><span class="p">);</span>

<span class="k">void</span> <span class="nf">ShowDetailsAndAddExtraInfo</span><span class="p">(</span><span class="n">LogEntry</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Display information about the Trace Sources and Listeners for this LogEntry. </span>
  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">LogSource</span><span class="p">&gt;</span> <span class="n">sources</span> <span class="p">=</span> <span class="n">defaultWriter</span><span class="p">.</span><span class="n">GetMatchingTraceSources</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">LogSource</span> <span class="n">source</span> <span class="k">in</span> <span class="n">sources</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Log Source name: &#39;{0}&#39;&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="n">TraceListener</span> <span class="n">listener</span> <span class="k">in</span> <span class="n">source</span><span class="p">.</span><span class="n">Listeners</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot; - Listener name: &#39;{0}&#39;&quot;</span><span class="p">,</span> <span class="n">listener</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Check if any filters will block this LogEntry.</span>
  <span class="c1">// This approach allows you to check for specific types of filter.</span>
  <span class="c1">// If there are no filters of the specified type configured, the GetFilter </span>
  <span class="c1">// method returns null, so check this before calling the ShouldLog method.</span>
  <span class="n">CategoryFilter</span> <span class="n">catFilter</span> <span class="p">=</span> <span class="n">defaultWriter</span><span class="p">.</span><span class="n">GetFilter</span><span class="p">&lt;</span><span class="n">Ca</span> <span class="n">tegoryFilter</span><span class="p">&gt;();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">catFilter</span> <span class="p">||</span> <span class="n">catFilter</span><span class="p">.</span><span class="n">ShouldLog</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">Categories</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Category Filter(s) will not block this LogEntry.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;A Category Filter will block this LogEntry.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">PriorityFilter</span> <span class="n">priFilter</span> <span class="p">=</span> <span class="n">defaultWriter</span><span class="p">.</span><span class="n">GetFilter</span><span class="p">&lt;</span><span class="n">PriorityFilter</span><span class="p">&gt;();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">priFilter</span> <span class="p">||</span> <span class="n">priFilter</span><span class="p">.</span><span class="n">ShouldLog</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">Priority</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Priority Filter(s) will not block this LogEntry.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;A Priority Filter will block this LogEntry.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Alternatively, a simple approach can be used to check for any type of filter</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">defaultWriter</span><span class="p">.</span><span class="n">ShouldLog</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;This LogEntry will not be blocked by config settings.&quot;</span><span class="p">);</span>
    <span class="c1">// Add context information to log entries after checking that the log entry</span>
    <span class="c1">// will not be blocked due to configuration settings. See the following</span>
    <span class="c1">// section &#39;Adding Additional Context Information&#39; for details.</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;This LogEntry will be blocked by configuration settings.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="toc_11">Add additional information</h3>

<p>Collect some useful information from environment. Some helper classes
- DebugInformationProvider
- ManagedSecurityContextInformationProvider
- UnmanagedSecurityContextInformationProvider: user name and process account name
- ComPlusInformationProvider</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="p">...</span>
<span class="c1">// Create additional context information to add to the LogEntry. </span>
<span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">dict</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;();</span>
<span class="c1">// Use the information helper classes to get information about </span>
<span class="c1">// the environment and add it to the dictionary.</span>
<span class="n">DebugInformationProvider</span> <span class="n">debugHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DebugInformationProvider</span><span class="p">();</span>
<span class="n">debugHelper</span><span class="p">.</span><span class="n">PopulateDictionary</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>

<span class="n">ManagedSecurityContextInformationProvider</span> <span class="n">infoHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManagedSecurityContextInformationProvider</span><span class="p">();</span>
<span class="n">infoHelper</span><span class="p">.</span><span class="n">PopulateDictionary</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>

<span class="n">UnmanagedSecurityContextInformationProvider</span> <span class="n">secHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UnmanagedSecurityContextInformationProvider</span><span class="p">();</span>
<span class="n">secHelper</span><span class="p">.</span><span class="n">PopulateDictionary</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>

<span class="n">ComPlusInformationProvider</span> <span class="n">comHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ComPlusInformationProvider</span><span class="p">();</span>
<span class="n">comHelper</span><span class="p">.</span><span class="n">PopulateDictionary</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>

<span class="c1">// Get any other information you require and add it to the dictionary.</span>
<span class="kt">string</span> <span class="n">configInfo</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s">@&quot;..\..\App.config&quot;</span><span class="p">);</span>
<span class="n">dict</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;Config information&quot;</span><span class="p">,</span> <span class="n">configInfo</span><span class="p">);</span>

<span class="c1">// Set dictionary in the LogEntry and write it using the default LogWriter.</span>
<span class="n">entry</span><span class="p">.</span><span class="n">ExtendedProperties</span> <span class="p">=</span> <span class="n">dict</span><span class="p">;</span>
<span class="n">defaultWriter</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">....</span>
</code></pre></div>
<h3 id="toc_12">Creating Custom Trace Listeners, Filters, and Formatters</h3>

<ul>
<li>Custom <strong>Filter</strong>: implement <strong>ILogFilter</strong></li>
<li>Custom <strong>Listener</strong>: inherit from the abstract base class <strong>CustomTraceListener</strong></li>
<li>Custom <strong>Formatter</strong>: implement <strong>ILogFormatter</strong>, or inherit <strong>LogFormatter</strong></li>
</ul>

		<div class="clear"></div>
	  </div>
	  <p class="alt-font tight">
		Posted in&nbsp;
		
		<a href="/categories/library" title="library" rel="category tag">library</a>
		
		&nbsp;&nbsp;&nbsp;
		Tags &nbsp;
		
			<a href="/tags/entlib/">entlib</a> &nbsp;
		
			<a href="/tags/logging/">logging</a> &nbsp;
		
	  </p>
		
	  <p class="by-line">
		<span class="date full-date">
		  <abbr class="published" title="2013-05-18 00:00:00 +0700">18 May 2013</abbr>
		</span>
	  </p>
	  <div class="clear"></div>
	</div>
</div>		     
    
    <br class="clearboth"/>
    <footer>
      Powered by <a href="https://jekyllrb.com" rel="generator">Jekyll</a>
    </footer>    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>            
  </body>
</html>